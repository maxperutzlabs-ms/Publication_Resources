---
title: "Interference Modeling in MS2-quantified multiplex proteomics"
author: "Moritz Madern"
date: "2023-02-10"
---

Data input:
1) MaxQuant PSM-table (typically named "msms.txt")    
2) thermo raw-files (*.raw)
3) rawStallion tool (https://github.com/fstanek/rawStallion)
4) isotopic impurity matrix
5) functions contained in "functions_IM.R"

Data output:
1) modified PSM-table named "PSM.txt"


This script extracts relevant information from the Thermo raw files, and subsequently models the PSM-wise total reporter ion signal. Based on the trained model, PSM-wise "estimated interference level" (EIL) values will be calculated. After between-sample normalization, the script performs interference-correction on the basis of calculated EIL values. A modified PSM-table is finally returned that contains PSM-wise EIL values as well as normalized uncorrected and normalized interference-corrected ("EIL-corrected") reporter ion intensities.
Note: This script currently supports MaxQuant as well as FragPite output as input.

```{r Load required packages and functions, echo=FALSE, message=FALSE, warning=FALSE}

## Load packages. If not installed yet, install them prior to running this script!
library(tidyverse)
library(readr)
library(pracma)
library(plot3D)
library(MASS)       
library(gridExtra)
library(rlist)
library(foreach)
library(doParallel)
library(fields)
library(cowplot)
library(MSnbase)    ## Bioconductor
library(limma)      ## Bioconductor
library(DESeq2)     ## Bioconductor
library(msqrob2)    ## Bioconductor


## Source functions from functions.R (contains the larger functions of this script)
source("./functions_IM.R")


## Create Results folder
if (!file.exists("Results")){
  dir.create("Results")
}

```


```{r Specify required parameters, echo=FALSE}

## Specify file path to the folder where Thermo raw files (ending with "*.raw") of the experiment are stored.
rawfilefolder_filepath = "./rawfiles"

## Specify file path to rawStallion.exe, a C#-tool for extracting noise values among other information from the *.raw files. Download here: https://github.com/fstanek/rawStallion.
rawStallion.exe_filepath = "./rawStallion/rawStallion.exe"

## Specify file path to the PSM-table generated by database searching (in MaxQuant the corresponding table is called msms.txt).
msms_filepath = "./20201030_QExHFX1_RSLC1_Madern_Hartl_UW_MFPL__complexity_RIQ-(1)_PSMs.txt"

## Optional: Specify specific pattern of raw file names which matches the raw files to be processed. Only relevant if not all of the PSMs in your PSM table are to be processed in the script (e.g. because some come from MS3 measurements, etc.). If all raw files are to be processed, specify parameter as empty character "".
rawfile_pattern_to_keep = ""  
## Specify name of the column denoting raw file identity for each PSM (=row) in the PSM-table. It will later be renamed as "Raw.file".
rawfile_columnname = "Spectrum.File"

## Specify name of the column denoting scan number for each PSM (=row) in the PSM-table. It will later be renamed as "Scan.number".
scannumber_columnname = "First.Scan"

## Specify name of the column denoting precursor ion charge for each PSM (=row) in the PSM-table. It will later be renamed as "Charge".
charge_columnname = "Charge"

## Specify name of the column denoting retention time for each PSM (=row) in the PSM-table. It will later be renamed as "Retention.time".
retentionTime_columnname = "RT.in.min" 

## Specify name of the column denoting precursor peptide amino acid sequence for each PSM (=row) in the PSM-table. It will later be renamed as "Sequence".
sequence_columnname =  ""

## Specify name of the column denoting protein identity for each PSM (=row) in the PSM-table.
proteinGroup_columnname = "Master.Protein.Accessions"

## Specify the search engine that was used to generate the PSM-table. Supported search engines so far: "MaxQuant", "FragPipe". The script might have to be adapted for other input sources.
search_engine = "MSAmanda"

## Specify the multiplexing labels used in the experiment. This parameter should be set as an object of the "ReporterIons" class used in the Bioconductor package "MSnBase", which comes with TMT6, TMT10, TMT11 and TMT16 as predefined objects. For more information, please see: https://lgatto.github.io/MSnbase/reference/ReporterIons-class.html.
reporter_ions = TMT16

## Optional: Correct for isotopic impurities of reporter ions by specifying an impurity matrix. If no impurity correction should be performed, set this parameter to NULL. Else, specify a purity correction matrix as an nxn matrix, where n is the number of channels in the kit. Columns represent reporter channels, and rows represent relative signal percentages. The order of columns and rows has to match that of the reporter_ions object specified above. For more information on how to construct an impurity matrix, please refer to the respective guide from "MSnBase": https://rdrr.io/github/lgatto/MSnbase/man/purityCorrect-methods.html. 
impuritymatrix = as.matrix(read.csv(file="./impurity_matrix_tmtpro.csv" , sep=",", header=TRUE, row.names = 1))  

## Specify name of the column denoting the precursor peptide modified amino acid sequence for each PSM (=row) in the PSM-table. This is required to infer specific peptide characteristics. In MaxQuant, this column is called "Modified.Sequence". An example entry is: "_(Acetyl (Protein N-term))SWQAYTDNLIGTGK_".
modifiedSequence_columnname = "Annotated.Sequence"

## Specify the TMT search setting as either "fixed" or "variable". If "fixed", it is assumed that sequences in the "Modified.Sequence" column will not show the TMT modification if found on the peptide. If "variable", it is assumed that a TMT-modification will be listed in the "Modified.Sequence" column at the respective position in the peptide's sequence. In that case, also specify the corresponding label pattern in the "Modified.Sequence" column as a regular expression pattern.
TMT_search_setting = ""
label_pattern = ""

## Specify the pattern of acetylation (encompassing both N-terminal and Lysine acetylation) in the "Modified.Sequence" column as a regular expression pattern. This is crucial for correctly calculating the number of TMT-labels per peptide.
acetylation_pattern = ""

## Optional: Specify an optional additional pattern in the "Modified.Sequence" column as a regular expression pattern specific to a post-translational modification (PTM). This will help accounting for differences in fragmentation efficiencies in the model. Note: It is assumed that this PTM does not confer an additional charge to the peptide under measurement conditions. If no special PTM pattern is present, specify as empty character "". Note: In my experience, neither Lysine (K) acetylation nor (STY) phosphorylation could explain much variance in terms of fragmentation efficiency. Maybe other PTMS/modifications do?
ptm_pattern = ""

## specify the between-sample normalization strategy to be applied on reporter ion intensities. Supported is "loess" and "DESeq". Normalization is required prior to interference-correction (which assumes an uniform interference background).
norm_strategy = "loess"

## Optional: Specify sample groups vector as character vector to perform filtering PSMs based on a minimum valid values threshold in at least 1 group. The order of entries should match the order of the reporter ion columns in your PSM-table.
groups = c("blank", "blank", "blank", "Group0", "Group6", "Group0", "Group6", "Group0", "Group6","blank", "Group9", "Group12", "Group9", "Group12", "Group9", "Group12")
minimum_valid_threshold = 3

## Optional: Specify the sample group names that represent empty channels in the input data (e.g. in case when using 16plex kit but only 12 channels are being used for labeling). Their respective reporter ion columns will be filtered out. This parameter requires specification of the empty group label as listed in the parameter "groups" above. If no group name corresponds to empty channels, specify as NULL.
groups_empty = "blank"





## Note: Parameters that are described as "Optional" can be ignored if certain steps are to be skipped. 
## Note: If specified correctly, no other user input is required for the remainder of the script!
## Note: If the script produces any errors, please check if all parameters were specified correctly!

```


```{r Read in PSM-table, echo=FALSE}

## Read in PSM-table:
df_msms <- read.delim(file=msms_filepath, header=TRUE, stringsAsFactors = FALSE, sep="\t") 
writeLines("Dimensions of PSM-table upon reading in:")
dim(df_msms)


## Rename some columns names to match them to the default-values of parameters of downstream functions and plots:
names(df_msms)[names(df_msms) == rawfile_columnname] <- "Raw.file"
names(df_msms)[names(df_msms) == scannumber_columnname] <- "Scan.number"
names(df_msms)[names(df_msms) == charge_columnname] <- "Charge"
names(df_msms)[names(df_msms) == retentionTime_columnname] <- "Retention.time"
names(df_msms)[names(df_msms) == proteinGroup_columnname] <- "Proteins"
names(df_msms)[names(df_msms) == sequence_columnname] <- "Sequence"
names(df_msms)[names(df_msms) == modifiedSequence_columnname] <- "Modified.sequence"


## If search_engine is FragPipe, modify columns appropriately to how they are needed
if (search_engine == "FragPipe"){
  # extract spectrum number matching fragpipe "Spectrum" column pattern and convert it into numeric vector
  scannr <- substring(df_msms$Scan.number, first=1, last= nchar(df_msms$Scan.number) -2)
  ind_last_point <- gregexpr(scannr, pattern="[.]") %>% sapply(., FUN="[", 2)
  scannr <- substring(scannr, first=ind_last_point + 1, last=nchar(scannr))
  df_msms$Scan.number <- as.numeric(scannr)
  
  # remove "pep.xml" in the rawfile column. Also rmove "interact-" at the front.
  df_msms$Raw.file <- sub(df_msms$Raw.file, pattern="[.]pep[.]xml", replacement = "")
  df_msms$Raw.file <- sub(df_msms$Raw.file, pattern="interact-", replacement = "")
}


## If search_engine is MaxQuant, filter out second peptides, reverse hits and contaminants
if (search_engine == "MaxQuant"){
  # get rid of second peptides:
  df_msms <- df_msms[df_msms$Type != "MULTI-SECPEP",]
  dim(df_msms)
  # get rid of reverse hits:
  df_msms <- df_msms[!df_msms$Reverse=="+",]
  dim(df_msms)
  # get rid of contaminants:
  con_bool <- grepl(df_msms$Proteins, pattern="^CON")
  df_msms <- df_msms[!con_bool,]
  writeLines("\nDimension of PSM-table after filtering out second peptides, reverse and CONs:")
  print(dim(df_msms))
}



## If search_engine is MSAmanda
if (search_engine == "MSAmanda"){
  # remove .raw at the end of raw file column
  df_msms$Raw.file <- sub(df_msms$Raw.file, pattern="[.]raw", replacement = "")
}



## Filter for raw files with specific pattern as specified via rawfile_pattern_to_keep parameter
if (!is.null(rawfile_pattern_to_keep)){
  df_msms <- df_msms[grepl(df_msms$Raw.file, pattern=rawfile_pattern_to_keep),]
}
writeLines("\nThe PSMs of these raw files will be processed:")
table(df_msms$Raw.file)


## Establish unique PSM identifier column called "unique_id"
df_msms$unique_id <- paste0(df_msms$Raw.file,"_",df_msms$Scan.number)


## Sort PSM-table by raw-file column
df_msms <- df_msms[order(df_msms$Raw.file),]

```


```{r Use rawStallion to read relevant information from Thermo raw files and write as R-readable .tsv files, echo=FALSE}

## Prepare parallel processing
cores <- detectCores(logical = TRUE)
cl <-makeCluster(cores - 2)
registerDoParallel(cl=cl)


## Execute rawStallion via command line (note: rawStallion requires a Windows OS)
invisible(
  foreach(i = list.files(rawfilefolder_filepath, full.names = TRUE)) %dopar% {
    system2(command = rawStallion.exe_filepath, args = i)
  }
)
print("Done.")
stopCluster(cl)


## Note: This code section should produce two .tsv-files per .raw file contained in the folder "rawfilefolder_filepath" by using rawStallion. If this code does not work, you might need to install some Windows extension, e.g. Windows .Net Desktop Runtime. I recommend running rawStallion.exe in the command line first (not via R) to see if and what exactly is missing! Windows will complain to you which exact extension is missing. 
## Note: To run rawStallion via the command line, type the following line in the Windows command line:
# [rawStallion.exe-filepath] [rawfile-filepath]   
# where [rawStallion.exe-filepath] is the filepath to the rawStallion.exe file, and
# [rawfile-filepath] is the filepath to a single Thermo .raw file

```


```{r Extract spectral features for each PSM from the raw data, echo=FALSE}

## Prepare parallel processing
cores <- detectCores(logical = TRUE)
cl <- makeCluster(cores - 1)
registerDoParallel(cl=cl)


## Apply function (see functions.R) to extract spectral features (noise values, reporter ion intensities, PPF, etc.) from raw the raw file data. It might take some time to go through every single PSM! Tasks are split on multiple cores to process multiple raw files in parallel.
t1 <- Sys.time() 
spectral_features <- extract_spectral_features_in_parallel(rawfilefolder_filepath = rawfilefolder_filepath, 
                                                               msms = df_msms,
                                                               scan_number = "Scan.number",
                                                               rawfile = "Raw.file",
                                                               charge = "Charge",
                                                               reporter_ions = reporter_ions,
                                                               mass_error_tolerance = 0.005)
stopCluster(cl)
t2 <- Sys.time()
writeLines("Duration of spectral feature extraction: ")
print(t2 - t1)


## Check if objects can be merged
if (!all(spectral_features$key_msms == df_msms$unique_id)){
  writeLines(warning("The two objects differ in order"))
}


## Merge spectral features to PSM table (df_msms)
df_msms <- cbind(df_msms, spectral_features[,-which(names(spectral_features) == "key_msms")])


## Compare PPF with exisitng purity metrics (if present)
if ("PIF" %in% names(df_msms)) {plot(x=df_msms$PIF, y=df_msms$PPF, cex=0.1, xlab="PIF",ylab="PPF")}  # PIF in MaxQuant output
if ("Purity" %in% names(df_msms)) {plot(x=df_msms$Purity, y=df_msms$PPF, cex=0.1, xlab="Purity",ylab="PPF")} # Purity in FragPipe Output
if ("Isolation.Interference.in.Percent" %in% names(df_msms)){{plot(x=1 - df_msms$Isolation.Interference.in.Percent/100, y=df_msms$PPF, cex=0.1, xlab="1-Isolation Interference",ylab="Precursor Purity Fraction")}} # Purity in MSAmanda Output


## Visualization of some of the calculated variables
barplot(table(df_msms$parent_MS1), main="MS1-occurence of precursor peptide ion", xlab="MS1", border="grey")
hist(df_msms$PPF, main="Distribution of Precursor Purity Fraction", xlab="Precursor Purity Fraction (PPF)", border="grey", col="grey")
ggplot(df_msms) +
  geom_line(aes(x=Retention.time, y=noiseValue, col=Raw.file)) +
  theme(legend.position = "bottom") 


## Save session image after MS1 feature extraction. Can be loaded at a later stage via load().
save.image(paste0("session_including_MS1_features_",Sys.Date(),".RData"))

```


Note: Currently, the column of "Modified.Sequence" is missing in the PD MSAmanda output to run the remainder of the script ("IM.Rmd") as it is currently coded. However, one could easily create such a column by manually by combining the two columns "Annotated.Sequence" and "Modifications".

